<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö... - Tourwow</title>
    
    <!-- Google Fonts - Kanit -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Kanit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #4a7ba7 0%, #2c5f8d 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #333;
      }

      .auth-container {
        text-align: center;
        background: white;
        padding: 3rem 2rem;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
      }

      .logo {
        margin-bottom: 2rem;
      }

      .logo img {
        max-width: 200px;
        height: auto;
      }

      .spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 1.5rem;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4a7ba7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      h1 {
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      p {
        color: #666;
        font-size: 0.95rem;
      }

      .error-message {
        display: none;
        background: #fee;
        color: #c33;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        font-size: 0.9rem;
      }

      .error-message.show {
        display: block;
      }

      .btn-retry {
        display: none;
        margin-top: 1rem;
        padding: 0.75rem 2rem;
        background: #4a7ba7;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-family: 'Kanit', sans-serif;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-retry:hover {
        background: #3a6a8f;
      }

      .btn-retry.show {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <div class="logo">
        <img src="https://financebackoffice-staging2.tourwow.com/assets/images/tourwow-logo.png" alt="Tourwow Logo" />
      </div>
      
      <div class="spinner"></div>
      
      <h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</h1>
      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
      
      <div class="error-message" id="errorMessage">
        ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏´‡∏£‡∏∑‡∏≠ Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      </div>

      <button class="btn-retry" id="btnRetry" onclick="redirectToLogin()">
        ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
      </button>

      <!-- Debug Info Box -->
      <div id="debugBox" style="display:none; margin-top:1rem; padding:1rem; background:#f0f0f0; border-radius:8px; text-align:left; font-size:0.75rem; font-family:monospace; max-height:200px; overflow:auto;">
        <strong>Debug Info:</strong>
        <pre id="debugLog" style="margin:0.5rem 0 0 0; white-space:pre-wrap; word-break:break-all;"></pre>
      </div>
    </div>

    <script>
      (function() {
        'use strict';

        // Debug logging helper
        const debugLogs = [];
        function debugLog(message) {
          console.log(message);
          debugLogs.push(message);
          updateDebugBox();
        }

        function updateDebugBox() {
          const debugBox = document.getElementById('debugBox');
          const debugLogEl = document.getElementById('debugLog');
          if (debugBox && debugLogEl) {
            debugBox.style.display = 'block';
            debugLogEl.textContent = debugLogs.join('\n');
          }
        }

        debugLog('=== AUTH DEBUG START ===');
        debugLog('Time: ' + new Date().toLocaleString('th-TH'));
        debugLog('URL: ' + window.location.href);
        debugLog('Search: ' + window.location.search);

        // Get token from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        debugLog('Token param exists: ' + (token ? 'YES' : 'NO'));
        debugLog('Token length: ' + (token ? token.length : 0));
        debugLog('Token preview: ' + (token ? token.substring(0, 30) + '...' : 'N/A'));

        // Check if localStorage/sessionStorage is available
        debugLog('--- Storage Check ---');
        try {
          localStorage.setItem('test', 'test');
          localStorage.removeItem('test');
          debugLog('localStorage: AVAILABLE');
        } catch (e) {
          debugLog('localStorage: BLOCKED - ' + e.message);
        }

        try {
          sessionStorage.setItem('test', 'test');
          sessionStorage.removeItem('test');
          debugLog('sessionStorage: AVAILABLE');
        } catch (e) {
          debugLog('sessionStorage: BLOCKED - ' + e.message);
        }

        if (token && token.trim() !== '') {
          try {
            debugLog('--- Storing Token ---');

            // Clear all existing tokens first to prevent conflicts
            sessionStorage.clear();
            localStorage.clear();
            debugLog('Cleared storage');

            // Store NEW token in BOTH sessionStorage AND localStorage (same key)
            sessionStorage.setItem('authToken', token);
            debugLog('Set sessionStorage');
            localStorage.setItem('authToken', token);
            debugLog('Set localStorage');

            // Verify token was stored correctly
            const storedSessionToken = sessionStorage.getItem('authToken');
            const storedLocalToken = localStorage.getItem('authToken');

            debugLog('Session token stored: ' + (storedSessionToken ? storedSessionToken.length + ' chars' : 'NO'));
            debugLog('Local token stored: ' + (storedLocalToken ? storedLocalToken.length + ' chars' : 'NO'));
            debugLog('Session match: ' + (storedSessionToken === token));
            debugLog('Local match: ' + (storedLocalToken === token));

            if (storedSessionToken === token && storedLocalToken === token) {
              debugLog('‚úÖ Token stored successfully!');

              // Decode and log token expiry for debugging
              try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const expDate = new Date(payload.exp * 1000);
                debugLog('Token exp: ' + expDate.toLocaleString('th-TH'));
                debugLog('Payload: ' + JSON.stringify(payload));
              } catch (e) {
                debugLog('‚ö†Ô∏è Could not decode: ' + e.message);
              }
            } else {
              throw new Error('Token verification failed - stored token does not match');
            }

            // Detect environment from hostname
            const hostname = window.location.hostname;
            let environment = hostname.includes('staging') ? 'staging' : 'production';
            debugLog('Environment: ' + environment);

            // Redirect to main page (clean URL) - use full path
            const redirectUrl = window.location.origin + '/tour-image-manager';
            debugLog('Redirecting to: ' + redirectUrl);
            debugLog('=== REDIRECT IN 2 SECONDS ===');

            setTimeout(() => {
              window.location.replace(redirectUrl);
            }, 2000); // Increased to 2 seconds for debugging

          } catch (error) {
            debugLog('‚ùå ERROR: ' + error.message);
            console.error('‚ùå Error storing token:', error);
            showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Token: ' + error.message);
          }
        } else {
          debugLog('‚ùå No token in URL!');
          console.error('‚ùå No token found in URL');
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }

        function showError(message) {
          const spinner = document.querySelector('.spinner');
          const heading = document.querySelector('h1');
          const paragraph = document.querySelector('p');
          const errorMessage = document.getElementById('errorMessage');
          const btnRetry = document.getElementById('btnRetry');

          spinner.style.display = 'none';
          heading.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
          paragraph.style.display = 'none';
          errorMessage.textContent = message;
          errorMessage.classList.add('show');
          btnRetry.classList.add('show');
        }

        window.redirectToLogin = function() {
          // Redirect to main login page based on environment
          const hostname = window.location.hostname;
          let loginUrl = 'https://financebackoffice.tourwow.com/login';
          
          if (hostname.includes('staging')) {
            loginUrl = 'https://financebackoffice-staging2.tourwow.com/login';
          }
          
          console.log('üîô Redirecting to login:', loginUrl);
          window.location.href = loginUrl;
        };

      })();
    </script>
  </body>
</html>
