# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏° Backend - ‡∏£‡∏∞‡∏ö‡∏ö Order Report

## üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ Frontend ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Orders ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ù‡∏±‡πà‡∏á Client ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î **429 Rate Limit Error**

## üéØ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
Backend ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á **7 Report Endpoints** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á Server ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤

---

## üì° Endpoints ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á

### 1. ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° Orders
**Endpoint:** `GET /api/reports/summary`

**Parameters ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö (Query String):**
- `travel_date_from` - ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (YYYY-MM-DD)
- `travel_date_to` - ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (YYYY-MM-DD)
- `booking_date_from` - ‡∏ß‡∏±‡∏ô‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (YYYY-MM-DD)
- `booking_date_to` - ‡∏ß‡∏±‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (YYYY-MM-DD)
- `country_id` - ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- `supplier_id` - ‡∏£‡∏´‡∏±‡∏™ Supplier

**‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö:**
```json
{
  "success": true,
  "data": {
    "total_orders": 1250,
    "total_customers": 890,
    "total_net_amount": 45678900.50,
    "avg_net_amount": 36543.12
  }
}
```

---

### 2. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
**Endpoint:** `GET /api/reports/by-country`

**Parameters:** ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠ 1

**‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö:**
```json
{
  "success": true,
  "data": [
    {
      "country_id": "TH",
      "country_name": "‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢",
      "total_orders": 450,
      "total_customers": 320,
      "total_net_amount": 15678900.50,
      "avg_net_amount": 34842.00
    }
  ]
}
```

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:**
- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏à‡∏≤‡∏Å field `product_snapshot` ‡πÉ‡∏ô Orders table
- Group by ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:
  - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Orders
  - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
  - ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° Net Amount
  - ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠ Order
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
- **‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£**

---

### 3. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Supplier
**Endpoint:** `GET /api/reports/by-supplier`

**Parameters:** ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠ 1

**‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö:**
```json
{
  "success": true,
  "data": [
    {
      "supplier_id": "SUP001",
      "supplier_name": "ABC Tour Company",
      "total_orders": 280,
      "total_customers": 210,
      "total_net_amount": 9876543.00,
      "avg_net_amount": 35273.37
    }
  ]
}
```

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:**
- Group by Supplier ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠ 2
- **‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£**

---

### 4. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
**Endpoint:** `GET /api/reports/by-travel-date`

**Parameters:** ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠ 1

**‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö:**
```json
{
  "success": true,
  "data": [
    {
      "travel_month": "2025-01",
      "travel_month_label": "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2568",
      "total_orders": 125,
      "total_customers": 98,
      "total_net_amount": 4567890.00
    }
  ]
}
```

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:**
- Group by ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
- `travel_month_label` ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + ‡∏õ‡∏µ ‡∏û.‡∏®.
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà
- **‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£**

---

### 5. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≠‡∏á
**Endpoint:** `GET /api/reports/by-booking-date`

**Parameters:** ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠ 1

**‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö:**
```json
{
  "success": true,
  "data": [
    {
      "booking_month": "2024-12",
      "booking_month_label": "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2567",
      "total_orders": 98,
      "total_customers": 76,
      "total_net_amount": 3456789.00
    }
  ]
}
```

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:**
- Group by ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏à‡∏≠‡∏á
- `booking_month_label` ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + ‡∏õ‡∏µ ‡∏û.‡∏®.
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà
- **‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£**

---

### 6. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥
**Endpoint:** `GET /api/reports/repeat-customers`

**Parameters:** ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠ 1

**‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö:**
```json
{
  "success": true,
  "data": [
    {
      "customer_id": "CUST001",
      "customer_code": "C001234",
      "customer_name": "‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ",
      "phone_number": "0812345678",
      "total_orders": 5,
      "total_spent": 234567.00,
      "countries": "‡πÑ‡∏ó‡∏¢, ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô, ‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ"
    }
  ]
}
```

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:**
- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ Orders **‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á**
- `countries` ‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≠‡∏á (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma)
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
- **‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£**

---

### 7. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
**Endpoint:** `GET /api/reports/countries`

**‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö:**
```json
{
  "success": true,
  "data": [
    {
      "id": "TH",
      "name_th": "‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢",
      "name_en": "Thailand"
    },
    {
      "id": "JP",
      "name_th": "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô",
      "name_en": "Japan"
    }
  ]
}
```

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:**
- ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å Orders (‡∏à‡∏≤‡∏Å `product_snapshot`)
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á A-Z ‡∏ï‡∏≤‡∏° `name_th`
- **‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô** (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)

---

### 8. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Wholesale ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
**Endpoint:** `GET /api/reports/wholesale-by-country`

**Parameters ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö (Query String):**
- `travel_date_from` - ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (YYYY-MM-DD)
- `travel_date_to` - ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (YYYY-MM-DD)
- `booking_date_from` - ‡∏ß‡∏±‡∏ô‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (YYYY-MM-DD)
- `booking_date_to` - ‡∏ß‡∏±‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (YYYY-MM-DD)
- `country_id` - ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- `supplier_id` - ‡∏£‡∏´‡∏±‡∏™ Supplier
- `view_mode` - **‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)** ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:
  - `sales` - ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (SUM ‡∏Ç‡∏≠‡∏á net_amount)
  - `travelers` - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (COUNT travelers)
  - `orders` - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (COUNT orders)
  - `net_commission` - **‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥** (‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)

**‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö:**
```json
{
  "success": true,
  "data": {
    "wholesales": [
      {
        "id": 46,
        "name": "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÇ‡∏õ‡∏£ ‡∏ö‡∏∏‡πä‡∏Ñ‡∏Å‡∏¥‡πâ‡∏á ‡πÄ‡∏ã‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î",
        "countries": {
          "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô": 150,
          "‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°": 80,
          "‡∏à‡∏µ‡∏ô": 45
        },
        "total": 275
      }
    ],
    "summary": {
      "total_value": 425,
      "view_mode": "net_commission",
      "top_wholesale": { "name": "...", "count": 275 },
      "top_country": { "name": "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô", "count": 250 },
      "total_partners": 15
    },
    "country_totals": {
      "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô": 250,
      "‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°": 80
    }
  }
}
```

> **‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:** ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô `countries`, `total`, `summary.total_value`, ‡πÅ‡∏•‡∏∞ `country_totals` ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏° `view_mode` ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô orders / ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á / ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:**
- Group by Supplier ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö wholesales ‡∏ï‡∏≤‡∏° total ‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì summary ‡πÅ‡∏•‡∏∞ country_totals
- **‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∞‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏° `view_mode`** (‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)

---

### ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏° view_mode

| view_mode | ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì | ‡∏™‡∏π‡∏ï‡∏£ |
|---|---|---|
| `sales` | ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° | `SUM(o.net_amount)` |
| `travelers` | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á | `SUM(o.pax)` ‡∏´‡∏£‡∏∑‡∏≠ COUNT travelers |
| `orders` | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå | `COUNT(DISTINCT o.id)` |
| `net_commission` | **‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥** | `SUM(COALESCE(o.supplier_commission, 0) - COALESCE(o.discount, 0))` |

---

### ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö view_mode = `net_commission`

‡πÄ‡∏°‡∏∑‡πà‡∏≠ `view_mode=net_commission` **‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°** ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

**1. ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:**
```
‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ = supplier_commission - discount
```

**2. ‡∏ï‡πâ‡∏≠‡∏á INNER JOIN ‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á installments:**
- JOIN ‡∏Å‡∏±‡∏ö `customer_order_installments` ‡πÇ‡∏î‡∏¢ `o.id = i.order_id`
- ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å** (`i.ordinal = 1`)
- ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà **‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß** (`LOWER(i.status) = 'paid'`)

**3. ‡∏Å‡∏£‡∏≠‡∏á Order ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å:**
- `o.order_status != 'Canceled'`

**4. ‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ (GMT+7):**
- ‡πÉ‡∏ä‡πâ `CONVERT_TZ(o.created_at, '+00:00', '+07:00')` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ

**SQL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏±‡∏ö Report ‡∏õ‡∏≠):**
```sql
-- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡∏ß‡∏° (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö Report ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á)
SELECT
    COALESCE(SUM(COALESCE(o.supplier_commission, 0) - COALESCE(o.discount, 0)), 0) AS total_net_commission
FROM
    tw_tourwow_db_views.v_Xqc7k7_orders AS o
INNER JOIN
    tw_tourwow_db_views.v_Xqc7k7_customer_order_installments AS i
    ON o.id = i.order_id
WHERE
    o.order_status != 'Canceled'
    AND i.ordinal = 1
    AND LOWER(i.status) = 'paid'
    AND YEAR(CONVERT_TZ(o.created_at, '+00:00', '+07:00')) = 2025;
```

**SQL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Group by Wholesale + Country (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö endpoint ‡∏ô‡∏µ‡πâ):**
```sql
SELECT
    o.supplier_id,
    s.name AS supplier_name,
    country.name AS country_name,
    COALESCE(SUM(COALESCE(o.supplier_commission, 0) - COALESCE(o.discount, 0)), 0) AS net_commission
FROM
    tw_tourwow_db_views.v_Xqc7k7_orders AS o
INNER JOIN
    tw_tourwow_db_views.v_Xqc7k7_customer_order_installments AS i
    ON o.id = i.order_id
LEFT JOIN suppliers s ON o.supplier_id = s.id
LEFT JOIN countries country ON o.country_id = country.id
WHERE
    o.order_status != 'Canceled'
    AND i.ordinal = 1
    AND LOWER(i.status) = 'paid'
    AND YEAR(CONVERT_TZ(o.created_at, '+00:00', '+07:00')) = 2025
    -- ‡πÄ‡∏û‡∏¥‡πà‡∏° filters ‡∏à‡∏≤‡∏Å query params ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
GROUP BY o.supplier_id, s.name, country.name
ORDER BY net_commission DESC;
```

> **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©:** ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Orders ‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà JOIN ‡∏Å‡∏±‡∏ö installments ‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏£‡∏ß‡∏° Orders ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢

---

## üîê Authentication
‡∏ó‡∏∏‡∏Å Request ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Header:
```
x-api-key: sk_test_4f8b2c9e1a3d5f7b9c0e2a4d6f8b1c3e
```

---

## üåê CORS Settings
‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Origins:
```
http://localhost:3000
http://localhost:3001
https://staging-finance-backoffice-report.vercel.app
https://finance-backoffice-report.vercel.app
```

‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Headers:
```
Content-Type
x-api-key
```

---

## ‚ö†Ô∏è ‡∏™‡∏¥‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á

### 1. Response Format ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ `success` ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà `status`
```json
// ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
{
  "success": true,
  "data": [...]
}

// ‚ùå ‡∏ú‡∏¥‡∏î - ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ
{
  "status": "success",
  "data": [...]
}
```

### 2. ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Records
- Report ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß: **‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£**
- ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô countries ‡πÅ‡∏•‡∏∞ suppliers: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

### 3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å field `product_snapshot` ‡πÉ‡∏ô Orders table
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"

### 4. Format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
- ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤: `YYYY-MM-DD` (‡πÄ‡∏ä‡πà‡∏ô `2025-01-14`)
- ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ: ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ endpoint

---

## üß™ Testing
‡πÉ‡∏ä‡πâ Token ‡∏ô‡∏µ‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
```
sk_test_4f8b2c9e1a3d5f7b9c0e2a4d6f8b1c3e
sk_test_9a7b5c3d1e2f4a6b8c0d2e4f6a8b0c2d
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ:**
```bash
curl -X GET "https://staging-finance-backoffice-report-api.vercel.app/api/reports/summary?travel_date_from=2025-01-01&travel_date_to=2025-01-31" \
  -H "x-api-key: sk_test_4f8b2c9e1a3d5f7b9c0e2a4d6f8b1c3e"
```

---

## üìä ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏°‡∏°‡∏ï‡∏¥)

### Orders Table
```
- id
- customer_id
- customer_code
- customer_name
- phone_number
- supplier_id
- travel_date
- booking_date
- net_amount
- product_snapshot (JSON - ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)
```

### Product Snapshot (JSON)
```json
{
  "country": {
    "id": "TH",
    "name_th": "‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢",
    "name_en": "Thailand"
  }
}
```

---

## ‚úÖ Checklist

- [ ] ‡∏™‡∏£‡πâ‡∏≤‡∏á 8 Endpoints ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ (‡∏£‡∏ß‡∏° wholesale-by-country + view_mode)
- [ ] ‡πÉ‡∏ä‡πâ `success: true` ‡πÉ‡∏ô Response (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà `status`)
- [ ] ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CORS ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (4 origins)
- [ ] ‡πÄ‡∏û‡∏¥‡πà‡∏° `x-api-key` ‡πÉ‡∏ô allowed headers
- [ ] ‡∏à‡∏≥‡∏Å‡∏±‡∏î 100 records (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô countries/suppliers)
- [ ] ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏à‡∏≤‡∏Å `product_snapshot`
- [ ] ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö `view_mode` parameter ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö wholesale-by-country (sales/travelers/orders/net_commission)
- [ ] net_commission: ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£ `supplier_commission - discount` + INNER JOIN installments (ordinal=1, status=paid)
- [ ] ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (null/undefined)
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å endpoint
- [ ] Deploy ‡∏Ç‡∏∂‡πâ‡∏ô staging
- [ ] ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à

---

## üí° Tips ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Performance

1. **Database Indexing:**
   - `travel_date`
   - `booking_date`
   - `country_id` (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
   - `supplier_id`
   - `customer_id`

2. **Caching:**
   - `/api/reports/countries` - cache 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
   - `/api/suppliers` - cache 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

3. **Query Optimization:**
   - ‡πÉ‡∏ä‡πâ `COUNT(DISTINCT customer_id)` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
   - ‡πÉ‡∏ä‡πâ `SUM()` ‡πÅ‡∏•‡∏∞ `AVG()` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
   - ‡πÉ‡∏ä‡πâ `GROUP BY` ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ loop

---

## üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏° Frontend ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
